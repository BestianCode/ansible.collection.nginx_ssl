global
    chroot          /var/lib/haproxy
    log             /dev/log local0
    log             /dev/log local1 notice
    stats           socket   /run/haproxy/admin.sock mode 660 level admin expose-fd listeners
    stats           timeout  30s
    user            haproxy
    group           haproxy
    node            {{ ansible_host }}
    daemon

    # Use multiple threads to handle high concurrency.
    # Override per-host with `haproxy_nbthread` if you need a fixed value.
    nbthread        {{ haproxy_nbthread | default(ansible_processor_vcpus | default(4)) }}

    maxconn         {{ haproxy_maxconn }}
    spread-checks   5

    ssl-default-bind-ciphers ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384
    ssl-default-bind-ciphersuites TLS_AES_128_GCM_SHA256:TLS_AES_256_GCM_SHA384:TLS_CHACHA20_POLY1305_SHA256

#    ssl-default-bind-options ssl-min-ver TLSv1.2 no-tls-tickets
    ssl-default-bind-options ssl-min-ver TLSv1.2

    tune.ssl.cachesize 100000
    tune.ssl.lifetime 600

defaults
    timeout         queue   {{ haproxy_timeout_queue }}
    timeout         client  {{ haproxy_timeout_client }}
    timeout         server  {{ haproxy_timeout_server }}
    timeout         connect {{ haproxy_timeout_connect }}

    retries         3
    option          persist
    option          redispatch
    option          splice-auto
    option          abortonclose

    option          clitcpka
    option          srvtcpka

    # MSS clamping to avoid fragmentation issues with VPN/tunnels
    #tcp-request     connection set-mss 1400

    log             global
    mode            tcp
    option          dontlog-normal
    option          dontlognull

    errorfile       400     /etc/haproxy/errors/400.http
    errorfile       403     /etc/haproxy/errors/403.http
    errorfile       408     /etc/haproxy/errors/408.http
    errorfile       500     /etc/haproxy/errors/500.http
    errorfile       502     /etc/haproxy/errors/502.http
    errorfile       503     /etc/haproxy/errors/503.http
    errorfile       504     /etc/haproxy/errors/504.http

{% if haproxy_backend_configurations is defined %}
{% for x in haproxy_backend_configurations %}

{{ x }}

{% endfor %}
{% endif %}

listen admin_stats
    bind        127.0.0.1:8404
    mode        http
    option      httplog
    stats       enable
    stats       uri /haproxy_status
    stats       show-legends
    stats       show-node
    stats       refresh 5s
    stats       admin if { src 127.0.0.1/32 }
    stats       show-legends
    stats       show-node
    stats       refresh 15s

listen prometheus_metrics
    bind        127.0.0.1:8405
    mode        http
    http-request use-service prometheus-exporter if { path /metrics }
    no          log
