{% if nginx_frontend_configurations is defined %}
{% for x in nginx_frontend_configurations %}

{% set _upstream_name = ('sg_upstream_' ~ loop.index0 ~ '_' ~ (x.dns | regex_replace('[^A-Za-z0-9_]', '_'))) %}
{% set _backend_port = (x.backend_port if x.backend_port is defined else none) %}

{% if x.backend is defined and (x.backend is sequence) and (x.backend is not string) %}
    upstream {{ _upstream_name }} {
{% for b in x.backend %}
{% if b is mapping %}
{% if b.address is defined %}
{% set _addr = b.address %}
{% if _backend_port is not none and (_addr | regex_search(':[0-9]+$')) is not truthy %}
{% set _addr = (_addr ~ ':' ~ _backend_port) %}
{% endif %}
    server {{ _addr }}{% if b.params is defined %} {{ b.params }}{% endif %};
{% elif b.host is defined and b.port is defined %}
        server {{ b.host }}:{{ b.port }}{% if b.params is defined %} {{ b.params }}{% endif %};
{% elif b.host is defined and _backend_port is not none %}
    server {{ b.host }}:{{ _backend_port }}{% if b.params is defined %} {{ b.params }}{% endif %};
{% endif %}
{% else %}
{% set _addr = b %}
{% if _backend_port is not none and (_addr | regex_search(':[0-9]+$')) is not truthy %}
{% set _addr = (_addr ~ ':' ~ _backend_port) %}
{% endif %}
    server {{ _addr }};
{% endif %}
{% endfor %}
    }
{% endif %}

    server {
        listen                      443 ssl http2;

        server_name                 {{x.dns}};

        ssl_certificate             {{ nginx_letsencrypt_live_dir }}/{{ x.domain }}/{{ nginx_ssl_certificate_filename }};
        ssl_certificate_key         {{ nginx_letsencrypt_live_dir }}/{{ x.domain }}/{{ nginx_ssl_certificate_key_filename }};
{% if x.send_timeout is defined %}

        keepalive_timeout           {{x.send_timeout}}s;
{% endif %}
{% if x.client_max_body_size is defined %}
        client_max_body_size        {{x.client_max_body_size}};

{% endif %}
        location / {
{% if x.cors is defined %}

            more_clear_headers      'Access-Control-Allow-Origin';
            more_clear_headers      'Access-Control-Allow-Methods';
            more_clear_headers      'Access-Control-Allow-Headers';
            more_clear_headers      'access-control-expose-headers';
            more_clear_headers      'x-powered-by';

            set $cors_origin "";

            if ($http_origin ~* "{{ x.cors }}") {
                set $cors_origin $http_origin;
            }

            if ($cors_origin = "") {
                set $cors_origin $http_referer;
            }

            if ($cors_origin !~* "{{ x.cors }}") {
{% if x.cors_origin_default is defined %}
                set $cors_origin {{ x.cors_origin_default }};
{% else %}
                set $cors_origin "";
{% endif %}
            }

            add_header              'Access-Control-Allow-Origin'  "$cors_origin"  always;
{% if x.cors_methods is defined %}
            add_header              'Access-Control-Allow-Methods' '{{ x.cors_methods }}';
{% endif %}
{% if x.cors_headers is defined %}
            add_header              'Access-Control-Allow-Headers' "{{ x.cors_headers }}";
{% endif %}

{% endif %}
{% if x.restrict is defined %}
{% for u in x.restrict %}
            if ($request_uri ~* "{{ u.uri }}") {
                return 403;
            }
{% endfor %}
{% endif %}
{% if x.mode is defined and x.mode.startswith('http') %}
            proxy_set_header        Host                $host;
            proxy_set_header        X-Forwarded-Proto   $scheme;
            proxy_set_header        X-Forwarded-Port    $server_port;
            proxy_set_header        X-Forwarded-For     $proxy_add_x_forwarded_for;
            proxy_set_header        X-Forwarded-Ssl     on;
            proxy_set_header        X-Real-IP           $remote_addr;
            proxy_http_version      1.1;

            proxy_set_header        Upgrade             $http_upgrade;
            proxy_set_header        Connection          $connection_upgrade;

{% if x.client_max_body_size is defined %}
            proxy_read_timeout      {{x.proxy_read_timeout}};
{% endif %}
{% if x.proxy_send_timeout is defined %}
            proxy_send_timeout      {{x.proxy_send_timeout}};
{% endif %}
{% if x.proxy_connect_timeout is defined %}
            proxy_connect_timeout   {{x.proxy_connect_timeout}};
{% endif %}
{% if x.send_timeout is defined %}
            send_timeout            {{x.send_timeout}};
{% endif %}

            proxy_buffering         off;

{% set _single_backend = x.backend %}
{% if _backend_port is not none and (_single_backend is string) and (_single_backend | regex_search(':[0-9]+$')) is not truthy %}
{% set _single_backend = (_single_backend ~ ':' ~ _backend_port) %}
{% endif %}

{% if x.backend is defined and (x.backend is sequence) and (x.backend is not string) %}
            proxy_pass              {{x.mode}}://{{ _upstream_name }};
{% else %}
            proxy_pass              {{x.mode}}://{{ _single_backend }};
{% endif %}
{% endif %}
{% if x.mode is defined and x.mode == 'grpc' %}
{% set _single_backend = x.backend %}
{% if _backend_port is not none and (_single_backend is string) and (_single_backend | regex_search(':[0-9]+$')) is not truthy %}
{% set _single_backend = (_single_backend ~ ':' ~ _backend_port) %}
{% endif %}
{% if x.backend is defined and (x.backend is sequence) and (x.backend is not string) %}
            grpc_pass               grpc://{{ _upstream_name }};
{% else %}
            grpc_pass               {{x.mode}}://{{ _single_backend }};
{% endif %}
{% endif %}
        }
    }
{% endfor %}
{% endif %}
