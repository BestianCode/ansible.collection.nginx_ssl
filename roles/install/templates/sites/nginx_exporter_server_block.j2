### Nginx exporter server block template

{% if nginx_exporter_server_block | default(true) %}
    server {
    listen              127.0.0.1:{{ nginx_exporter_server_block_port | default(80) }} default_server;
{% if nginx_ipv6 | default(false) %}
    listen              [::1]:{{ nginx_exporter_server_block_port | default(80) }} default_server;
{% endif %}

        server_name         _;

        access_log          off;
        error_log           off;

        location {{ nginx_exporter_server_block_location | default('/metrics') }} {
    {% for network in nginx_exporter_server_block_allow_networks | default(['127.0.0.1/32']) %}
    {% set clean_network = (network | string | regex_replace('\s*#.*$', '') | regex_replace('\s*;.*$', '') | trim) %}
    {% if clean_network %}
            allow                   {{ clean_network }};
    {% endif %}
    {% endfor %}
            deny                    all;

            proxy_set_header        Host                $host;
            proxy_set_header        X-Forwarded-Proto   $scheme;
            proxy_set_header        X-Forwarded-Port    $server_port;
            proxy_set_header        X-Forwarded-For     $proxy_add_x_forwarded_for;
            proxy_set_header        X-Forwarded-Ssl     on;
            proxy_set_header        X-Real-IP           $remote_addr;
            proxy_http_version      1.1;
            proxy_buffering         off;

            proxy_pass              {{ nginx_exporter_server_block_scrape_url | default('http://127.0.0.1:9113/metrics') }};
        }
    }
{% endif %}
